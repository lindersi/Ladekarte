<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- iOS Web App Einstellungen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ladekarte CH">
    
    <title>Smart Ladekarte Schweiz</title>

    <!-- Tailwind CSS f√ºr modernes Design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons f√ºr sch√∂ne Symbole -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Markdown Parser f√ºr sch√∂ne Antworten -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #f0f0f0;
            overscroll-behavior: none;
            touch-action: none; 
        }

        #map-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        /* UI Overlay Layer (√ºber der Karte) */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 50;
            pointer-events: none; /* Klicks gehen durch, ausser auf Buttons */
        }

        /* Elemente, die klickbar sein m√ºssen */
        .interactive {
            pointer-events: auto;
        }

        /* Chat Fenster Animationen */
        .chat-enter {
            transform: translateY(100%);
            opacity: 0;
        }
        .chat-enter-active {
            transform: translateY(0);
            opacity: 1;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .chat-exit {
            transform: translateY(100%);
            opacity: 0;
            transition: all 0.3s ease-in;
        }

        /* Markdown Styles im Chat */
        .prose p { margin-bottom: 0.5rem; }
        .prose ul { list-style-type: disc; padding-left: 1.2rem; margin-bottom: 0.5rem; }
        .prose strong { font-weight: 600; color: #1e3a8a; }
    </style>
</head>
<body>

    <!-- Karten Container -->
    <div id="map-container">
        <iframe 
            src="https://map.geo.admin.ch/embed.html?topic=energie&lang=de&bgLayer=ch.swisstopo.pixelkarte-grau&layers=ch.bfe.ladestellen-elektromobilitaet&catalogNodes=2597,2602&mobile=true&zoom=2" 
            allow="geolocation" 
            title="Ladekarte Schweiz">
        </iframe>
    </div>

    <!-- UI Overlay -->
    <div id="ui-layer" class="flex flex-col justify-end p-4 pb-8 sm:pb-4">
        
        <!-- Chat Fenster (Versteckt per Default) -->
        <div id="chat-window" class="interactive hidden w-full max-w-md mx-auto bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden border border-gray-200" style="height: 60vh; max-height: 500px;">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-600 to-indigo-700 p-4 flex justify-between items-center text-white">
                <div class="flex items-center gap-2">
                    <i data-lucide="sparkles" class="w-5 h-5 text-yellow-300"></i>
                    <h2 class="font-bold">Lade-Concierge</h2>
                </div>
                <button onclick="toggleChat()" class="hover:bg-white/20 p-1 rounded-full transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Chat Area -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
                <!-- Begr√ºssung -->
                <div class="flex gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="bot" class="w-5 h-5 text-blue-600"></i>
                    </div>
                    <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm border border-gray-100 text-sm text-gray-700">
                        Hoi! Ich bin dein KI-Assistent. Wie kann ich die Ladezeit vers√ºssen?
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="grid grid-cols-2 gap-2 mt-2">
                    <button onclick="fillPrompt('Ich lade in [Ort] f√ºr [Minuten]. Was kann ich dort tun?')" class="text-xs bg-white border border-blue-200 text-blue-700 p-2 rounded-lg hover:bg-blue-50 text-left transition flex items-center gap-2">
                        <span class="text-base">‚òï</span> Pause planen
                    </button>
                    <button onclick="fillPrompt('Mein Ladekabel l√§sst sich nicht entriegeln. Was tun?')" class="text-xs bg-white border border-red-200 text-red-700 p-2 rounded-lg hover:bg-red-50 text-left transition flex items-center gap-2">
                        <span class="text-base">üÜò</span> Notfall Hilfe
                    </button>
                    <button onclick="fillPrompt('Erkl√§re mir den Unterschied zwischen Typ 2 und CCS.')" class="text-xs bg-white border border-gray-200 text-gray-700 p-2 rounded-lg hover:bg-gray-50 text-left transition flex items-center gap-2">
                        <span class="text-base">üîå</span> Stecker-Infos
                    </button>
                    <button onclick="fillPrompt('Wie funktionieren Lade-Apps und Roaming in der Schweiz?')" class="text-xs bg-white border border-gray-200 text-gray-700 p-2 rounded-lg hover:bg-gray-50 text-left transition flex items-center gap-2">
                        <span class="text-base">üí≥</span> Bezahlung
                    </button>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-3 bg-white border-t border-gray-100">
                <form onsubmit="handleSend(event)" class="relative">
                    <input id="user-input" type="text" placeholder="Frag mich etwas..." class="w-full pl-4 pr-12 py-3 bg-gray-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <button type="submit" id="send-btn" class="absolute right-2 top-2 p-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </form>
            </div>
        </div>

        <!-- Floating Action Button (FAB) -->
        <div class="flex justify-end mt-4 interactive">
            <button onclick="toggleChat()" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg transition-transform transform hover:scale-105 active:scale-95 flex items-center gap-2 group">
                <i data-lucide="sparkles" class="w-6 h-6 animate-pulse"></i>
                <span class="font-medium pr-1 group-hover:block hidden md:block">KI Assistent</span>
            </button>
        </div>
    </div>

    <script>
        // Init Icons
        lucide.createIcons();

        // State
        let isChatOpen = false;
        const apiKey = ""; // API Key wird zur Laufzeit injiziert
        
        // DOM Elements
        const chatWindow = document.getElementById('chat-window');
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');

        function toggleChat() {
            isChatOpen = !isChatOpen;
            if (isChatOpen) {
                chatWindow.classList.remove('hidden');
                chatWindow.classList.add('chat-enter-active');
                setTimeout(() => userInput.focus(), 100);
            } else {
                chatWindow.classList.add('hidden');
                chatWindow.classList.remove('chat-enter-active');
            }
        }

        function fillPrompt(text) {
            userInput.value = text;
            userInput.focus();
            // Optional: Auto-Send wenn gew√ºnscht, hier lassen wir den User editieren (z.B. Ort einf√ºgen)
            if(!text.includes('[')) {
                handleSend(new Event('submit'));
            }
        }

        async function handleSend(e) {
            e.preventDefault();
            const text = userInput.value.trim();
            if (!text) return;

            // User Message
            appendMessage('user', text);
            userInput.value = '';
            sendBtn.disabled = true;

            // Loading Indicator
            const loadingId = appendMessage('bot', '<span class="animate-pulse">Denke nach... ‚ú®</span>');

            try {
                const response = await callGemini(text);
                updateMessage(loadingId, response);
            } catch (error) {
                console.error(error);
                updateMessage(loadingId, "Entschuldigung, ich habe gerade Verbindungsprobleme. Versuch es sp√§ter nochmal.");
            }

            sendBtn.disabled = false;
        }

        function appendMessage(role, htmlContent) {
            const div = document.createElement('div');
            div.className = 'flex gap-3 ' + (role === 'user' ? 'flex-row-reverse' : '');
            
            const id = 'msg-' + Date.now();
            div.id = id;

            const iconHtml = role === 'user' 
                ? `<div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0"><i data-lucide="user" class="w-5 h-5 text-indigo-600"></i></div>`
                : `<div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0"><i data-lucide="bot" class="w-5 h-5 text-blue-600"></i></div>`;

            const bubbleClass = role === 'user'
                ? 'bg-blue-600 text-white rounded-tr-none'
                : 'bg-white border border-gray-100 text-gray-700 rounded-tl-none';

            div.innerHTML = `
                ${iconHtml}
                <div class="p-3 rounded-2xl shadow-sm text-sm max-w-[85%] prose ${bubbleClass}">
                    ${htmlContent}
                </div>
            `;
            
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            lucide.createIcons();
            return id;
        }

        function updateMessage(id, markdownText) {
            const msgBubble = document.querySelector(`#${id} .prose`);
            if (msgBubble) {
                msgBubble.innerHTML = marked.parse(markdownText);
            }
        }

        async function callGemini(userPrompt) {
            // System Prompt: Kontext setzen
            const systemInstruction = `Du bist ein hilfreicher Assistent f√ºr Elektroauto-Fahrer in der Schweiz. 
            Du befindest dich in einer Web-App, die eine Karte aller Ladestationen anzeigt.
            
            Deine Aufgaben:
            1. Wenn der Nutzer einen Ort und Zeit nennt, gib 2-3 konkrete Tipps f√ºr Aktivit√§ten in der N√§he (Caf√©s, Parks, Sehensw√ºrdigkeiten). Sei kreativ!
            2. Wenn der Nutzer technische Probleme hat (Kabel steckt fest, S√§ule rot), gib kurze Sicherheitshinweise und Troubleshooting-Tipps.
            3. Erkl√§re Begriffe (AC, DC, Typ 2, CCS) einfach und verst√§ndlich.
            
            Stil:
            - Antworte kurz und pr√§gnant (f√ºr mobile Ansicht).
            - Nutze Emojis sparsam aber passend.
            - Formatierung: Nutze Fettgedrucktes f√ºr Wichtiges.
            - Sei freundlich und "Schweizerisch" h√∂flich (nutze aber Hochdeutsch).
            `;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{
                    parts: [{ text: userPrompt }]
                }],
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                }
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error('API Error');
            
            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "Keine Antwort erhalten.";
        }
    </script>
</body>
</html>
